<!DOCTYPE html>
<!-- Last Modify : 2017.03.16 -->
<html>
	<head>
		<meta charset="utf-8">
		
		<title>Kwik Print Main Page</title>
		
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <link rel='stylesheet' href='./css/jquery.mobile-1.4.5.css'  type="text/css" />
		<script src="./js/jquery.min.js" type="text/javascript"></script>
		<script src="./js/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
		<script type="text/javascript" src="cordova.js"></script>
	
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script type="text/javascript" src="js/kwikinit.js"></script>
		<style>
			<!--.userform { padding:.8em 1.2em; }
			.userform h2 { color:#555; margin:0.3em 0 .8em 0; padding-bottom:.5em; border-bottom:1px solid rgba(0,0,0,.1); }
			.userform label { display:block; margin-top:1.2em; }
			.switch .ui-slider-switch { width: 6.5em !important }
			.ui-grid-a { margin-top:1em; padding-top:.8em; margin-top:1.4em; border-top:1px solid rgba(0,0,0,.1); } -->
			
			input:required {
				background : ;
				box-shadow: 1px 1px 5px rgba(200, 0, 0, 0.85);
			}		
			input[readonly] {
				background-color : #fceccc;
			} 
				
        </style>
	
	<script>
	

	var g_uid ;  // Firebase UID gobal variable
	var g_userRef ; // Firebase user Reference gobal variable
	var g_photoDataURI ; // Photo of the uses
	
	function logout() {
		firebase.auth().signOut().then(function() {
			window.sessionStorage.setItem("firebaseUser", null); // Clear user session storage 
			//window.location = "login.html";
			window.location = "index.html#pageLogin";
		}, function(error) {
			// An error happened 
			alert("Logout Failed");
		});
	}
	
	$(document).ready( function() {
		if (typeof(window.cordova)!="undefined") {	 // Check Phonegap or browser
			document.addEventListener("deviceready", onDeviceReady, false);    // For Phone Gap
		} else {	// For testing in chrome		
			onDeviceReady();	// For Browser
		}
	}); 
	
	function reloadFirebase() {
		$.mobile.loading('show'); // Show loading 	
		
		if (sessionStorage.getItem("firebaseUser")) {
			var fuser =  JSON.parse(sessionStorage.getItem("firebaseUser"));			
			var uid = fuser.uid ;
			g_uid = uid ;
//alert("firebase user : " + uid); 		
			// Retrieve user info from firebase database 
			var ref = firebaseDB.ref("users/" + uid);
			g_userRef = ref; 
					
			ref.once("value", function(data) {			
//alert("data " + data.val().user_name);
//alert("data : " + JSON.stringify(data.val()));	
				fdb_userInfo = data.val();		
				$("#userEmail").html(data.val().email_address ) ;
				$("#userName").html(data.val().user_name) ;
				// User Profile data
				$("#p_emailAddress").val(data.val().email_address);
				$("#p_userName").val(data.val().user_name);
				$("#p_phoneno").val(data.val().phone_no);
//alert("img : " + data.val().avatar_image);				
				if (data.val().avatar_image) { g_photoDataURI = data.val().avatar_image ; }
				// Fill the photo
				$("#userPhoto").attr("src", g_photoDataURI); //.load(function() { this.width; }); 
				fillCanvas();				
				//$('#p_photoCanvas')[0].getContext('2d').drawImage( $("#userPhoto"), 0, 0, 100, 100 ) ;
				$("#p_bal").html(data.val().account_balance);
				
				$.mobile.loading( "hide") ;	
//alert("user name " + $("#p_userName").val());				
			}, function(err) { 
				alert("Error " + err) ;
			});	
	
		}
			
	}
	
	function onDeviceReady() {
//alert("gobal user " +  sessionStorage.getItem("firebaseUser"));	
//console.log("ready firebase " + firebase.auth().currentUser);
//alert("ready firebase " + firebase.auth().currentUser );
//		window.firebaseUser  = firebase.auth().currentUser;
//$.mobile.loading('show'); // Show loading 	

//$.mobile.loading( "show", {text: "loading"}) ;

		//if (sessionStorage.getItem("firebaseUser")) {
 		
			//var fuser =  JSON.parse(sessionStorage.getItem("firebaseUser"));
//			$("#userEmail").html(fuser.email);
//			$("#userName").html(fuser.displayName);
//			$("#userEmail").html(window.firebaseUser.email) ;

			
			//var uid = fuser.uid ;
			//g_uid = uid ;
			// Retrieve user info from firebase database 
			//var ref = firebaseDB.ref("users/" + uid);
			//g_userRef = ref; 
			
			//ref.once("value", function(data) {			
	//alert("data " + data.val().user_name);
//alert("data : " + JSON.stringify(data.val()));	
//alert("img : " + data.val().avatar_file_url.image);
				//fdb_userInfo = data.val();		
				//$("#userEmail").html(data.val().email_address ) ;
				//$("#userName").html(data.val().user_name) ;
				// User Profile data
				//$("#p_emailAddress").val(data.val().email_address);
				//$("#p_userName").val(data.val().user_name);
				
				//if (data.val().avatar_file_url.image) { g_photoDataURI = data.val().avatar_file_url.image ; }
				// Fill the photo
				//$("#userPhoto").attr("src", g_photoDataURI); //.load(function() { this.width; }); 
//fillCanvas();				
				//$('#p_photoCanvas')[0].getContext('2d').drawImage( $("#userPhoto"), 0, 0, 100, 100 ) ;
	//			$.mobile.loading( "hide") ;
//alert("user name " + $("#p_userName").val());				
		//	});	
		//}
		reloadFirebase();
		setTimeout(gpsCheck,1000);
		// Direct to user profile page when user's photo is clicked
		$("#userPhoto").on("click", function() {
			$.mobile.pageContainer.pagecontainer("change", "#userProfile") ;
		});
		
	} // End Device Ready

	function gpsCheck() {
		cordova.plugins.diagnostic.isGpsLocationEnabled(function(enabled){
		//Diagnostic.isLocationEnabled(function(enabled) {
			console.log("GPS location is " + (enabled ? "enabled" : "disabled"));
		}, function(error){
			alert("Please enable the GPS first !");		
			console.error("The following error occurred: "+error);
		}); 
	}
	
	function fillCanvas() {
		var myCanvas = document.getElementById('p_photoCanvas');
		var ctx = myCanvas.getContext('2d');
		var img = new Image;
		img.onload = function(){
			ctx.drawImage(img,0,0); // Or at whatever offset you like
		};
//alert("fill : " + g_photoDataURI);
		img.src = g_photoDataURI;
		$("#userPhoto").attr('src', g_photoDataURI);
	}
	
/*	
	firebase.auth().onAuthStateChanged(function(user) {

  		if (user) {
    // User is signed in.
			window.firebaseUser  = firebase.auth().currentUser;	
			$("#userEmail").html(window.firebaseUser.email) ;
	//alert("dname " + window.firebaseUser.uid);
			var ref = firebaseDB.ref("users/" + user.uid.toString());
			ref.once("value", function(data) {
	//alert("data " + data.val().user_name);
				$("#userName").html(data.val().user_name) ;
			});	
//alert("name: " + window.firebaseUser.uid);			
  		} else {
    	// No user is signed in.
			alert("login failed");
			window.location="login.html";
  		}
	});
*/	
	</script>
		
	</head>
	<body>
		<div data-role="page" class="ui-responsive-panel" id="mainPage">

			<!-- div data-role="header" data-theme="a"-->
			<div data-id="header" data-theme="a" data-position="fixed" data-role="header" data-tap-toggle="false" data-transition="none">
				<h1>Kwik Print</h1>
				<a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
				<a href="#add-form" data-icon="gear" data-iconpos="notext">Add</a>

				<div style="background-color:white;">
				<table width="100%" >
					<tr>
					<td rowspan="2" width="110px">
						<img src="" id="userPhoto" width="100px" height="100px" style="display:inline;"> 
					</td>
					<td>
						<div style="vertical-align:top;display:inline;margin:3px;text-align:left;" id="userName" >User Name</div>
					</td>
					</tr>
					<tr>
					<td>
						<div style="vertical-align:top;display:block;margin:3px;text-align:left;" id="userEmail" >Email</div>
					</td>
					</tr>
				</table>
				</div>
				<div data-role="header" data-theme="b" >
					<h3>Messages</h3>
				</div>
			</div><!-- /header -->
			<!-- div data-role="content" style="margin:0px; padding:0px;" --> 
			<div role="main" class="ui-content"  style="margin:0px; padding:0px;">
				</div>
				<!-- div data-role="content"  class="scrollable"--> 
				<div data="main"  class="ui-content scrollable" >
				<ul data-role="listview" data-theme="a"> 
					<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>
					
										<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>

										<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>

										<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>

					
				</ul>	
				</div> <!-- /content-->

				<!--div data-role="panel" data-position="left" data-position-fixed="false" data-display="reveal" id="nav-panel" data-theme="a"-->
				<div data-role="panel" data-position="left" data-position-fixed="false" data-display="overlay" id="nav-panel" data-theme="a">

					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="close">Close menu</a>
						</li>
						<li data-filtertext="">
							<a href="javascript:location='./mapsearh.html'">Printer Search</a>
						</li>
						<li data-filtertext="">
							<a href="#">Chat</a>
						</li>
						<li data-filtertext="ajax navigation model">
							<a href="#">Transactions</a>
						</li>				
					</ul>
					<!-- panel content goes here -->
				</div><!-- /panel -->



				<div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="add-form" data-theme="b">
					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" >
						<li data-icon="" style="background-color:#111;">
							<a href="#" data-rel="close">...</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#userProfile" data-transition="slide">User Profile</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#myPrinter" data-transition="slide">My Printer</a>
						</li>
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="logout" onclick="logout();">Logout</a>
						</li>
					</ul>
				</div><!-- /panel -->
				
		</div><!-- /page -->

					
		<div data-role="page" id="userProfile" class="ui-responsive-panel"  data-add-back-btn="true" >

				<!-- div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="setup" data-theme="b">
					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
						<li data-icon="" style="background-color:#111;">
							<a href="#" data-rel="close">...</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#userProfile">User Profile</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#">My Printer</a>
						</li>
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="logout" onclick="logout();">Logout</a>
						</li>
					</ul>
				</div -->
	
		<header data-role="header" data-id="header" data-theme="b"  data-add-back-btn="true"  data-position="fixed"data-tap-toggle="false" data-transition="none" >
		<h1>User Profile</h1>
			<!-- a data-role="button" href="#nav-panel" data-icon="" class="ui-btn-left" data-iconpos="notext">Menu</a -->
			<a data-role="button" href="#mainPage" data-icon="back" class="ui-btn-left"  data-iconpos="notext">Back</a>
			<!-- a href="#setup" data-icon="gear" class="ui-btn-right" data-iconpos ="notext">Setup</a -->
		</header>	
 
		<!-- div id="profileForm" data-role="content" -->
		<div id="profileForm" role="main" class="ui-content">
			<form id="userProfile_form">
			<div data-role="fieldcontain">
			<label for="p_emailAddr">Email Address:</label>
			<input name="p_emailAddr" title="Sign in Email Address" class="input-disabled"  type="text" id="p_emailAddress"  
				placeholder="" autocomplete="off" readonly />
							
			<label for="p_userName">User Name:<span class='red'>*</span></label>
			<input required="" name="p_userName" title="Enter user name here." type="text" id="p_userName"
				placeholder="Enter user name here." autocomplete="off" data-clear-btn="true" />
			
			<label for="p_phoneno">Contact Phone No.:</label>
			<input name="p_phoneno" title="Contact Phone No." type="number" id="p_phoneno"
				placeholder="Enter contact phone no. here." autocomplete="off" />			
			
			
				<div data-role="fieldcontain" >
					<label for="p_selectPhoto">Avatar Image:(100 x 100 pixels) </label>
					<table>
					<tr>
					<td>
					<canvas width="100px" height="100px" id="p_photoCanvas" style="border:1px solid #000080;background-color:#f0f0f0;" ></canvas>
					<canvas width="20px" height="20px" id="p_photoSmall" style="border:1px solid #000080;background-color:#f0f0f0;display:none;" ></canvas>
					</td>
					<td>
					<input type="file" autocomplete="off" title="Enter User Photo" id="p_selectPhoto" name="p_photo" accept="image/*"  data-clear-btn="false" >	
					</td>
					</tr>
					</table>
		
				</div>
			
				<div style="text-align: center">
				<button type="submit"  data-inline="false"  id="saveProfile" class="center-button" onclick="" data-theme="b">SAVE</button> 
				<!-- a  class="ui-btn ui-btn-inline" href="#mainPage" data-transition="slide" data-inline="true"  >BACK</a -->
				</div>
				</form>
				<hr>
				<label style="display:inline-block">Account Balance : </label>
				<span id="p_bal" style="bold;color:red;display:inline-block"></span>
			</div> <!-- fieldcontain -->
					
		</div> <!-- content -->
		</div> <!-- End User Profile Page -->
		
		
		
		<!-- Printer Info Page --->							
		<div data-role="page" id="myPrinter" class="ui-responsive-panel"  data-add-back-btn="true" >
		<header data-role="header" data-id="header" data-theme="b"  data-add-back-btn="true"  data-position="fixed"data-tap-toggle="false" data-transition="none" >
		<h1>My Printer</h1>
			<a data-role="button" href="#mainPage" data-icon="back" class="ui-btn-left" data-iconpos="notext">Back</a>
			<!--a data-role="button" href="#printerMenu" data-icon="bars" class="ui-btn-right" data-iconpos="notext">Edit</a-->
		</header>	
		
			<!--div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="printerMenu" data-theme="b">
				<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
					<li data-icon="" style="background-color:#111;">
						<a href="#" data-rel="close">...</a>
					</li>
					<li data-icon="" style="background-color:#111;">
						<a href="#editPrinter" onclick="sessionStorage.editType='ADD'" data-transition="slide">Add Printer</a>
					</li>

				</ul>
			</div --><!-- /panel -->
		
			<!-- div id="printerList" data-role="content" --> 
			<div id="printerList" role="main" class="ui-content">
			<div class="content-primary">	
				<ul data-role="listview">
				
					<li data-role="list-divider" role="heading">
						<div style="text-align:left;display:inline-block;width:60%;font-size:14pt;" >Printer List</div> 
						<div style="text-align:right;display:inline-block;width:40%;">
							<a href="#editPrinter" onclick="sessionStorage.editType='ADD';" data-role="button"  data-transition="slide" 
							data-mini="true" data-icon="plus" data-inline="true" data-theme="a">Add</a>
						</div>
					</li>
					<li><a href="#"><h2>Printer Name1</h2>
					<p>Brother Printer Color Printer</p>
					<p>Model:MFC-1012</p>
					</a>
					
					<a href="#" data-rel="popup" data-position-to="window" data-transition="pop" data-icon="edit">Edit Printer</a>
					</li>
					
				</ul>
				
			</div>
		
			</div>
			
			
		</div> 
		<!-- End Printer Info Page --->	
		
		<!-- Printer Edit Page --->							
		<div data-role="page" id="editPrinter" class="ui-responsive-panel"  data-add-back-btn="true" >
		<header data-role="header" data-id="header" data-theme="b"  data-add-back-btn="true"  data-position="fixed"data-tap-toggle="false" data-transition="none" >
		<h1 id="peditHeader">Add Printer</h1>
			<a data-role="button" href="#myPrinter" data-icon="back" class="ui-btn-left" data-transition="slide" data-direction="reverse" data-iconpos="notext">Back</a>
			<!-- a data-role="button" href="#printerMenu" data-icon="bars" class="ui-btn-right" data-iconpos="notext">Back</a -->
		</header>	
			<div id="printeredit" data-role="header">
			<!--h2 id="peditPname">New Printer</h2-->
			</div>
			<div role="main" class="ui-content">
			<form id="printEdit_form" >
			<Label for="">Band Name</label>
			<input type="text" id="pr_bandName" placeholder="Band Name(Max 20 char.)" maxlength="20"  required>
			<Label for="">Model</label>
			<input type="text" id="pr_model" placeholder="Printer Model(Max 16 char.)" maxlength="16"  required>
			<Label for="">Printer Description</label>
			<input type="text" id="pr_desc" placeholder="Printer Description(Max 40 char.)" maxlength="40" style="resize:none;">
		
			<Label for="">Price of Rental (£ per day)</label>
			<input type="number" id="pr_price" placeholder="Price of Rental per day" maxlength="6"  required>
			
			
			<div class="ui-grid-a" style="background-color:#f4d4e8;">
			<label><b><i>Printer Location:</i></b></label>
				<div class="ui-block-a">
					<label>Longitude</label>
					<input type="number" id="pr_long" placeholder="Longitude" maxlength="10">
				</div>
				<div class="ui-block-b">
					<Label>Latitude</Label>
					<input type="number" id="pr_lat" placeholder="Latitude" maxlength="10">
				</div>
				<Label for="">Printer Address</label>
				<textarea rows="1" cols="20" id="pr_desc" placeholder="Printer Address(Max 60 char.)" maxlength="60" style="resize:none;"></textarea>
				<button data-icon="location" style="background-color:#f993b2;">Get current location</button>
			</div>
	
			<button type="submit" data-theme="b" id="savePrinter">SAVE</button>
			</form>
			</div>
		
			
		</div> 
		<!-- End Printer Edit Page --->	
		
		<script>
		// Load and preview Image
		$(function() {
			
			// Load and Preview Picture
			$('#p_selectPhoto').change(function(e) {
				var file = e.target.files[0],
				imageType = /image.*/;
                
				var reader = new FileReader();
				reader.onload = function(e){
					var $img = $('<img>', { src: e.target.result });		
					var canvas = $('#p_photoCanvas')[0];
					canvas.width = 100; // clear canvas and set the size to 100
					canvas.height = 100;
					var context = canvas.getContext('2d');
					$img.load(function(ev) {	
						$('#p_photoCanvas')[0].getContext('2d').drawImage(this, 0, 0, 100, 100);
//console.log("resize:"+canvas.toDataURL('image/jpeg'));		
						$('#p_photoSmall')[0].getContext('2d').drawImage(this, 0, 0, 20, 20);
					});
				};
				reader.readAsDataURL(file);
        
			});			
		
			// Function for Saving User Profile
			//$("#saveProfile").click( function() { 
			$("#userProfile_form").on("submit", function() { 
//alert("save : " + $("#p_photoCanvas")[0].toDataURL("image/jpeg") );
				var imgData = $("#p_photoCanvas")[0].toDataURL("image/jpeg") ;
				var imgDataSmall = $("#p_photoSmall")[0].toDataURL("image/jpeg") ;
				//g_userRef.child("avatar_file_url").set( {"image" : imgData})
				//g_userRef.child("avatar_file_url").set( imgData)
				g_userRef.update({ 	
					"avatar_image" : imgData,  
					"avatar_image_small" : imgDataSmall,
					"phone_no" : $("#p_phoneno").val(),
					"user_name" : $("#p_userName").val(),
					"Last_Update_date" : getCurrentDateTime()
				}) 
				.then( function() {
					//alert("saved");
					reloadFirebase();
					$.mobile.pageContainer.pagecontainer("change", "#mainPage");
				})
				.catch( function(error) {
					var errorcode = error.code; 
					var errorMessage = error.message;
				});
						
			}) ;
			
			// Show Printer Edit Screen
			$("#editPrinter").on("pageshow", function(event) {
				if ( sessionStorage.editType == "ADD") {
					$("#peditHeader").html("Add Printer") ;
					$("#peditPname").html("New Printer");
				} else {
					$("#peditHeader").html("Edit Printer") ;
					$("#peditPname").html("Printer:");
				}
			
			});
		
			// Function for Saving Printer Info
			$("#printEdit_form").on("submit",  function() { 
				var prn_model = $("#pr_model").val();
				var prn_band = $("#pr_bandName").val();
				var prn_desc = $("#pr_desc").val();
				var prn_price = $("#pr_price").val();
				//alert("save printer : " + $("#p_photoCanva
				if ( sessionStorage.editType == "ADD") {	// Add a printer 
//alert("add printer:" + prn_model);
				// Get a key for a new Post.
var newPostKey = firebase.database().ref().child('printer_info').push().key;
//alert("new key " + newPostKey);
var postData= {"printer_name": prn_band, "model" : prn_model} ;
  var updates = {};
  updates['/printer_info/' + newPostKey] = postData;
//alert(":guser" + g_userRef);
	updates[ "/users/" + g_uid +  "/printerID" ] = newPostKey;
//alert(":update:" + JSON.stringify(updates));
  	return firebase.database().ref().update(updates);
 

				}	
				
			});
		
		});
		
		</script>
	</body>
</html>
