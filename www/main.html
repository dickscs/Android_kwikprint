<!DOCTYPE html>
<!-- Last Modify : 2017.04.01 -->
<html>
	<head>
		<meta charset="utf-8">
		
		<title>Kwik Print</title>
		
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <link rel='stylesheet' href='./css/jquery.mobile-1.4.5.css'  type="text/css" />
		<script src="./js/jquery.min.js" type="text/javascript"></script>
		<script src="./js/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
		<!--  Google Map Javascript API -->
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAldk41ArYQ0WfSnox09Qn9_f4dwMb8OI0"></script>
		<script type="text/javascript" src="cordova.js"></script>		
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<!-- <script type="text/javascript" src="js/diagnostic.js"></script> -->
		<script type="text/javascript" src="js/kwikinit.js"></script>
		<style>
			input:required {
				background : ;
				box-shadow: 1px 1px 5px rgba(200, 0, 0, 0.85);
			}		
			input[readonly] {
				background-color : #fceccc;
			} 
        </style>
	
	<script>
	

	var g_uid ;  // Firebase UID gobal variable
	var g_userRef ; // Firebase user Reference gobal variable
	var g_photoDataURI ; // Photo of the uses
	var g_printList = []  ; // Printer List
	
	function logout() {
		firebase.auth().signOut().then(function() {
			window.sessionStorage.setItem("firebaseUser", null); // Clear user session storage 
			window.sessionStorage.setItem("gpsChecked", null);
			//window.location = "login.html";
			window.location = "index.html#pageLogin";
		}, function(error) {
			// An error happened 
			alert("Logout Failed");
		});
	}
	
	$(document).ready( function() {
		if (typeof(window.cordova)!="undefined") {	 // Check Phonegap or browser
			document.addEventListener("deviceready", onDeviceReady, false);    // For Phone Gap
		} else {	// For testing in chrome		
			onDeviceReady();	// For Browser
		}
	}); 
	

	function reloadFirebase() {
		$.mobile.loading('show'); // Show loading 	
		
		if (sessionStorage.getItem("firebaseUser")) {
			var fuser =  JSON.parse(sessionStorage.getItem("firebaseUser"));			
			var uid = fuser.uid ;
			g_uid = uid ;
//alert("firebase user : " + uid); 		
			// Retrieve user info from firebase database 
			var ref = firebaseDB.ref("users/" + uid);
			g_userRef = ref; 
					
			ref.once("value", function(data) {			
//alert("data " + data.val().user_name);
//alert("data : " + JSON.stringify(data.val()));	
				fdb_userInfo = data.val();		
				$("#userEmail").html(data.val().email_address ) ;
				$("#userName").html(data.val().user_name) ;
				// User Profile data
				$("#p_emailAddress").val(data.val().email_address);
				$("#p_userName").val(data.val().user_name);
				$("#p_phoneno").val(data.val().phone_no);
//alert("img : " + data.val().avatar_image);				
				if (data.val().avatar_image) { g_photoDataURI = data.val().avatar_image ; }
				// Fill the photo
				$("#userPhoto").attr("src", g_photoDataURI); //.load(function() { this.width; }); 
				fillCanvas();				
				//$('#p_photoCanvas')[0].getContext('2d').drawImage( $("#userPhoto"), 0, 0, 100, 100 ) ;
				$("#p_bal").html(data.val().account_balance);
				
				$.mobile.loading( "hide") ;	
//alert("user name " + $("#p_userName").val());				
			}, function(err) { 
				alert("Error " + err) ;
			});	
	
		}
			
	}
	
	function onDeviceReady() {
//alert("gobal user " +  sessionStorage.getItem("firebaseUser"));	
//console.log("ready firebase " + firebase.auth().currentUser);
//alert("ready firebase " + firebase.auth().currentUser );
//		window.firebaseUser  = firebase.auth().currentUser;
//$.mobile.loading('show'); // Show loading 	

//$.mobile.loading( "show", {text: "loading"}) ;

		//if (sessionStorage.getItem("firebaseUser")) {
 		
			//var fuser =  JSON.parse(sessionStorage.getItem("firebaseUser"));
//			$("#userEmail").html(fuser.email);
//			$("#userName").html(fuser.displayName);
//			$("#userEmail").html(window.firebaseUser.email) ;

			
			//var uid = fuser.uid ;
			//g_uid = uid ;
			// Retrieve user info from firebase database 
			//var ref = firebaseDB.ref("users/" + uid);
			//g_userRef = ref; 
			
			//ref.once("value", function(data) {			
	//alert("data " + data.val().user_name);
//alert("data : " + JSON.stringify(data.val()));	
//alert("img : " + data.val().avatar_file_url.image);
				//fdb_userInfo = data.val();		
				//$("#userEmail").html(data.val().email_address ) ;
				//$("#userName").html(data.val().user_name) ;
				// User Profile data
				//$("#p_emailAddress").val(data.val().email_address);
				//$("#p_userName").val(data.val().user_name);
				
				//if (data.val().avatar_file_url.image) { g_photoDataURI = data.val().avatar_file_url.image ; }
				// Fill the photo
				//$("#userPhoto").attr("src", g_photoDataURI); //.load(function() { this.width; }); 
//fillCanvas();				
				//$('#p_photoCanvas')[0].getContext('2d').drawImage( $("#userPhoto"), 0, 0, 100, 100 ) ;
	//			$.mobile.loading( "hide") ;
//alert("user name " + $("#p_userName").val());				
		//	});	
		//}
//alert("gps " + window.sessionStorage.getItem("gpsChecked"));		
///*******************************
//alert(sessionStorage.getItem("gpsChecked"));
		if ( sessionStorage.getItem("gpsChecked")==null ) {
//alert("gps check");		
			gpsCheck();
			sessionStorage.setItem("gpsChecked" ,"true");	
		} 

		reloadFirebase();
		
		//setTimeout(gpsCheck,1000);
		// Direct to user profile page when user's photo is clicked
		$("#userPhoto").on("click", function() {
			$.mobile.pageContainer.pagecontainer("change", "#userProfile") ;
		});
	
	} // End Device Ready
/////////////
	//$.noConflict();
	$(document).ready(function($) {
	
		//gpsCheck();
		function getMyLoc() {
			//setTimeout(gpsCheck,2000);
			//gpsCheck();
			$.mobile.loading('show'); // Show loading 	
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition( function(pos) {
					var latlng  = new google.maps.LatLng(  pos.coords.latitude,  pos.coords.longitude);
					var geocoder = geocoder = new google.maps.Geocoder();
					geocoder.geocode({ 'latLng': latlng }, function (results, status) {
                		if (status == google.maps.GeocoderStatus.OK) {
                    		if (results[1]) {
                        		//alert("Location: " + results[1].formatted_address);
								//return { "lat" :  pos.coords.latitude, "lng" :  pos.coords.longitude, "addr" : results[1].formatted_address};
								$("#pr_lat").val(pos.coords.latitude);
								$("#pr_long").val(pos.coords.longitude);
								$("#pr_addr").val(results[1].formatted_address.substring(0,60));
								$.mobile.loading('hide'); // Hide loading 	
                    		}
                		}

           			});
				}	
				, function(err) {
					console.log(err.message);
					$.mobile.loading('hide'); // Hide loading 	
					alert("Can't get location.\Try again later, make sure GPS is turned ON.\n" + err.message);
				} 
				, {maximumAge: 300000, enableHighAccuracy:true, timeout: 15000} );  // Wait 15 seconds for location finding
			}				
		
		}
		
		$("#btn_getlocation").on("click", function () {
			if (confirm("Are you sure to fill in current location data?")) {			
				getMyLoc();
				return ; 
			}
		});
		
		
	});
	
	function gpsCheck() {
		//var deferred =  $.Deferred();

		try {
			cordova.plugins.diagnostic.isGpsLocationEnabled(function(enabled){
			//cordova.plugins.diagnostic.isLocationEnabled(function(enabled){
//cordova.plugins.diagnostic.switchToLocationSettings();			
			//Diagnostic.isLocationEnabled(function(enabled) {
				console.log("GPS location is " + (enabled ? "enabled" : "disabled"));
				if (!enabled) {
					cordova.plugins.diagnostic.switchToLocationSettings();	
				}
				
alert("enable : " + enabled); 				
			}, function(error){
				alert("Please enable the GPS first !");		
				console.error("The following error occurred: " + error);
alert("error : " + error); 				
				cordova.plugins.diagnostic.switchToLocationSettings();		
			});
		} catch (e) {
alert("catch " + e);		
			console.error("GPS error : " + e) ;
			alert("Please make sure your GPS is turned ON.\n\n" + e);
			try {
				cordova.plugins.diagnostic.switchToLocationSettings();	
			} catch (e) {
				console.log(e);
			}
		}
	}
	
	function fillCanvas() {
		var myCanvas = document.getElementById('p_photoCanvas');
		var ctx = myCanvas.getContext('2d');
		var img = new Image;
		img.onload = function(){
			ctx.drawImage(img,0,0); // Or at whatever offset you like
		};
		img.src = g_photoDataURI;
		$("#userPhoto").attr('src', g_photoDataURI);
	}
		
	</script>
		
	</head>
	<body>
		<div data-role="page" class="ui-responsive-panel" id="mainPage">

			<!-- div data-role="header" data-theme="a"-->
			<div data-id="header" data-theme="a" data-position="fixed" data-role="header" data-tap-toggle="false" data-transition="none">
				<h1>Kwik Print</h1>
				<a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
				<a href="#add-form" data-icon="gear" data-iconpos="notext">Add</a>

				<div style="background-color:white;">
				<table width="100%" >
					<tr>
					<td rowspan="2" width="110px">
						<img src="" id="userPhoto" width="100px" height="100px" style="display:inline;"> 
					</td>
					<td>
						<div style="vertical-align:top;display:inline;margin:3px;text-align:left;" id="userName" >User Name</div>
					</td>
					</tr>
					<tr>
					<td>
						<div style="vertical-align:top;display:block;margin:3px;text-align:left;" id="userEmail" >Email</div>
					</td>
					</tr>
				</table>
				</div>
				<div data-role="header" data-theme="b" >
					<h3>Messages</h3>
				</div>
			</div><!-- /header -->
			<!-- div data-role="content" style="margin:0px; padding:0px;" --> 
			<div role="main" class="ui-content"  style="margin:0px; padding:0px;">
				</div>
				<!-- div data-role="content"  class="scrollable"--> 
				<div data="main"  class="ui-content scrollable" >
				<ul data-role="listview" data-theme="a"> 
					<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>
					
										<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>

										<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>

										<li> 
					<div style="float:left;">User A</div><div style="float:right;">message date</div>
					<div style="clear:both;"> Message from user a </div>
					</li>
					<li> 
					<div style="float:left;">User b</div><div style="float:right;">2017-01-18</div>
					<div style="clear:both;"> Message form user b</div>
					</li>

					
				</ul>	
				</div> <!-- /content-->

				<!--div data-role="panel" data-position="left" data-position-fixed="false" data-display="reveal" id="nav-panel" data-theme="a"-->
				<div data-role="panel" data-position="left" data-position-fixed="false" data-display="overlay" id="nav-panel" data-theme="a">
					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="close">Close menu</a>
						</li>
						<li data-filtertext="">
							<a href="javascript:location='./mapsearh.html'">Printer Search</a>
						</li>
						<li data-filtertext="">
							<a href="#">Chat</a>
						</li>
						<li data-filtertext="ajax navigation model">
							<a href="#">Transactions</a>
						</li>				
					</ul>
					<!-- panel content goes here -->
				</div><!-- /panel -->

				<div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="add-form" data-theme="b">
					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" >
						<li data-icon="" style="background-color:#111;">
							<a href="#" data-rel="close">...</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#userProfile" data-transition="slide">User Profile</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#myPrinter" data-transition="slide">My Printer</a>
						</li>
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="logout" onclick="logout();">Logout</a>
						</li>
					</ul>
				</div><!-- /panel -->
				
		</div><!-- /page -->

					
		<div data-role="page" id="userProfile" class="ui-responsive-panel"  data-add-back-btn="true" >

				<!-- div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="setup" data-theme="b">
					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
						<li data-icon="" style="background-color:#111;">
							<a href="#" data-rel="close">...</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#userProfile">User Profile</a>
						</li>
						<li data-icon="" style="background-color:#111;">
							<a href="#">My Printer</a>
						</li>
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="logout" onclick="logout();">Logout</a>
						</li>
					</ul>
				</div -->
	
		<header data-role="header" data-id="header" data-theme="b"  data-add-back-btn="true"  data-position="fixed"data-tap-toggle="false" data-transition="none" >
		<h1>User Profile</h1>
			<!-- a data-role="button" href="#nav-panel" data-icon="" class="ui-btn-left" data-iconpos="notext">Menu</a -->
			<a data-role="button" href="#mainPage" data-icon="back" class="ui-btn-left"  data-iconpos="notext">Back</a>
			<!-- a href="#setup" data-icon="gear" class="ui-btn-right" data-iconpos ="notext">Setup</a -->
		</header>	
 
		<!-- div id="profileForm" data-role="content" -->
		<div id="profileForm" role="main" class="ui-content">
			<form id="userProfile_form" action="">
			<div data-role="fieldcontain">
			<label for="p_emailAddr">Email Address:</label>
			<input name="p_emailAddr" title="Sign in Email Address" class="input-disabled"  type="text" id="p_emailAddress"  
				placeholder="" autocomplete="off" readonly />
							
			<label for="p_userName">User Name:<span class='red'>*</span></label>
			<input required="" name="p_userName" title="Enter user name here." type="text" id="p_userName"
				placeholder="Enter user name here." autocomplete="off" data-clear-btn="true" />
			
			<label for="p_phoneno">Contact Phone No.:</label>
			<input name="p_phoneno" title="Contact Phone No." type="number" id="p_phoneno"
				placeholder="Enter contact phone no. here." autocomplete="off" />			
			
			
				<div data-role="fieldcontain" >
					<label for="p_selectPhoto">Avatar Image:(100 x 100 pixels) </label>
					<table>
					<tr>
					<td>
					<canvas width="100px" height="100px" id="p_photoCanvas" style="border:1px solid #000080;background-color:#f0f0f0;" ></canvas>
					<canvas width="20px" height="20px" id="p_photoSmall" style="border:1px solid #000080;background-color:#f0f0f0;display:none;" ></canvas>
					</td>
					<td>
					<input type="file" autocomplete="off" title="Enter User Photo" id="p_selectPhoto" name="p_photo" accept="image/*"  data-clear-btn="false" >	
					</td>
					</tr>
					</table>
		
				</div>
			
				<div style="text-align: center">
				<button type="submit"  data-inline="false"  id="saveProfile" class="center-button" onclick="" data-theme="b">SAVE</button> 
				<!-- a  class="ui-btn ui-btn-inline" href="#mainPage" data-transition="slide" data-inline="true"  >BACK</a -->
				</div>
				</form>
				<hr>
				<label style="display:inline-block">Account Balance : </label>
				<span id="p_bal" style="bold;color:red;display:inline-block"></span>
			</div> <!-- fieldcontain -->
					
		</div> <!-- content -->
		</div> <!-- End User Profile Page -->
		
		
		
		<!-- Printer Info Page --->							
		<div data-role="page" id="myPrinter" class="ui-responsive-panel"  data-add-back-btn="true" >
		<header data-role="header" data-id="header" data-theme="b"  data-add-back-btn="true"  data-position="fixed"data-tap-toggle="false" data-transition="none" >
		<h1>My Printer</h1>
			<a data-role="button" href="#mainPage" data-icon="back" class="ui-btn-left" data-iconpos="notext">Back</a>
			<!--a data-role="button" href="#printerMenu" data-icon="bars" class="ui-btn-right" data-iconpos="notext">Edit</a-->
		</header>	
		
			<!--div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="printerMenu" data-theme="b">
				<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
					<li data-icon="" style="background-color:#111;">
						<a href="#" data-rel="close">...</a>
					</li>
					<li data-icon="" style="background-color:#111;">
						<a href="#editPrinter" onclick="sessionStorage.editType='ADD'" data-transition="slide">Add Printer</a>
					</li>

				</ul>
			</div --><!-- /panel -->
		
			<div id="printerList" role="main" class="ui-content">
			<div class="content-primary">	
				<ul data-role="listview" id="printul">
					<li data-role="list-divider" role="heading" id="PrintListHeader">
						<div style="text-align:left;display:inline-block;width:60%;font-size:14pt;" >Printer List</div> 
						<div style="text-align:right;display:inline-block;width:40%;">
							<a href="#editPrinter" onclick="sessionStorage.editType='ADD';" data-role="button"  data-transition="slide" 
							data-mini="true" data-icon="plus" data-inline="true" data-theme="a">Add</a>
						</div>
					</li>
				</ul>
				
			</div>
		
			</div>
			
			
		</div> 
		<!-- End Printer Info Page --->	
		
		<!-- Printer Edit Page --->							
		<div data-role="page" id="editPrinter" class="ui-responsive-panel"  data-add-back-btn="true" >
		<div data-role="header" id="pheader" data-theme="b"  data-add-back-btn="true"  data-position="fixed"data-tap-toggle="false" data-transition="none" >
		<h1 id="peditHeader">   </h1>
			<a data-role="button" href="#myPrinter" data-icon="back" class="ui-btn-left" data-transition="slide" data-direction="reverse" data-iconpos="notext">Back</a>
			<!--a data-role="button" href="#printerMenu" data-icon="bars" class="ui-btn-right" data-iconpos="notext">Back</a -->
		</div>	
		<!-- Edit Printer Right Menu -->
		<div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="pedit-panel" data-theme="a" >
			<ul data-role="listview" >
				<li><a href="#" data-rel="close" data-icon="minus">...</a></li>
				<li data-icon="alert"><a href="#" data-icon="delete" id="btn_pdelete" >Delete Printer</a></li>
			</ul>
		</div >

		<div role="main" class="ui-content">
			<form id="printEdit_form" autocomplete="off">
			<div class="ui-grid-a" style="margin-top:-15px;">
				<div class="ui-block-a">
				<Label for="" >Brand</label>
				<input type="text" id="pr_brandName" placeholder="Brand Name(Max 20 char.)" maxlength="20"  required>
				</div>
			<div class="ui-block-b">
			<Label for="">Model</label>
			<input type="text" id="pr_model" placeholder="Printer Model(Max 16 char.)" maxlength="16"  required>
			</div>
			</div>
			<Label for="">Printer Description</label>
			<input type="text" id="pr_desc" placeholder="Printer Description(Max 40 char.)" maxlength="40" style="resize:none;">
		
			<Label for="">Price of Rental (£ per day)</label>
			<input type="number" step="0.01" id="pr_price" placeholder="Price of Rental per day" maxlength="6"  required>
			
			
			<div class="ui-grid-a" style="background-color:#f4d4e8;">
			<label><b><i>Printer Location:</i></b></label>
				<div class="ui-block-a">
					<label>Longitude</label>
					<input type="number" step="any" id="pr_long" placeholder="Longitude" maxlength="11">
				</div>
				<div class="ui-block-b">
					<Label>Latitude</Label>
					<input type="number" step="any" id="pr_lat" placeholder="Latitude" maxlength="11">
				</div>
				<Label for="">Printer Address</label>
				<textarea rows="1" cols="20" id="pr_addr" placeholder="Printer Address(Max 60 char.)" maxlength="60" style="resize:none;"></textarea>
				<button type="button" data-icon="location" id="btn_getlocation" style="background-color:#f993b2;" >Get current location</button>
				<!--input type="button" value="Get current location" style="background-color:#f993b2;"-->
			</div>
			<input type="hidden" id="pr_printerID" >
			<button type="submit" data-theme="b" id="savePrinter">SAVE</button>
			</form>
			</div>
		
		</div> 
		<!-- End Printer Edit Page --->	
		
		
		</body>
		
		<script>
		
		// Init. Printer Edit screen
		function editPrn(idx) {
				idx -- ; 
				sessionStorage.editType = "EDIT" ; 
//alert( "prn : " + JSON.stringify( g_printList[idx] ) ) ;
				$.mobile.pageContainer.pagecontainer("change", "#editPrinter");
				$("#pr_brandName").val(g_printList[idx].brand) ;
				$("#pr_model").val(g_printList[idx].model) ;
				$("#pr_desc").val(g_printList[idx].description) ;	
				$("#pr_price").val(g_printList[idx].price) ;	
//alert(g_printList[idx].price);				
				$("#pr_long").val(g_printList[idx].location_longitude) ;	
				$("#pr_lat").val(g_printList[idx].location_latitude) ;	
				$("#pr_addr").val(g_printList[idx].location_address) ;	
				$("#pr_printerID").val(g_printList[idx].printerID);
//alert($("#pr_printerID").val());		
		}

			
		// Load and preview Image
		$(function() {  // old 
		//$(document).on('mobileinit', function()  {	
		//$(document).on('pageinit', function()  {	
			
			// Load and Preview Picture
			$('#p_selectPhoto').change(function(e) {
				var file = e.target.files[0],
				imageType = /image.*/;
                
				var reader = new FileReader();
				reader.onload = function(e){
					var $img = $('<img>', { src: e.target.result });		
					var canvas = $('#p_photoCanvas')[0];
					canvas.width = 100; // clear canvas and set the size to 100
					canvas.height = 100;
					var context = canvas.getContext('2d');
					$img.load(function(ev) {	
						$('#p_photoCanvas')[0].getContext('2d').drawImage(this, 0, 0, 100, 100);
//console.log("resize:"+canvas.toDataURL('image/jpeg'));		
						$('#p_photoSmall')[0].getContext('2d').drawImage(this, 0, 0, 20, 20);
					});
				};
				reader.readAsDataURL(file);
        
			});			
		
			// Function for Saving User Profile
			//$("#saveProfile").click( function() { 
			$("#userProfile_form").on("submit", function() { 
				event.preventDefault(); 		// Disable default form submit action 
//alert("save : " + $("#p_photoCanvas")[0].toDataURL("image/jpeg") );
				var imgData = $("#p_photoCanvas")[0].toDataURL("image/jpeg") ;
				var imgDataSmall = $("#p_photoSmall")[0].toDataURL("image/jpeg") ;
				//g_userRef.child("avatar_file_url").set( {"image" : imgData})
				//g_userRef.child("avatar_file_url").set( imgData)
				g_userRef.update({ 	
					"avatar_image" : imgData,  
					"avatar_image_small" : imgDataSmall,
					"phone_no" : $("#p_phoneno").val(),
					"user_name" : $("#p_userName").val(),
					"Last_Update_date" : getCurrentDateTime()
				}) 
				.then( function() {
					//alert("saved");
					reloadFirebase();
					$.mobile.pageContainer.pagecontainer("change", "#mainPage");
				}, function(error) {
					alert("Error : " + error ); 
					//var errorMessage = error.message ;
				});
			}) ;
	
			// Show Printer Edit Screen
			$("#editPrinter").on("pageshow", function(event) {
			//$.mobile.document.on( "pageshow", "#editPrinter", function() {
	
				if ( sessionStorage.editType == "ADD") {
					$("#peditHeader").html("Add Printer") ;
					
					$("#pr_brandName").val("") ;
					$("#pr_model").val("") ;
					$("#pr_desc").val("");
					$("#pr_price").val("");
					$("#pr_long").val("");
					$("#pr_lat").val("");
					$("#pr_addr").val("");
					$("#pr_printerID").val("");
					//$("#peditPname").html("New Printer");
				} else {
					$("#peditHeader").html("Edit Printer") ;
					//$("#peditPname").html("Printer:");
					$("#peditHeader").append('<a data-role="button" href="#pedit-panel" data-icon="bars" class="ui-btn-right" data-iconpos="notext">Edit</a>').enhanceWithin();
					$.mobile.resetActivePageHeight();
				}
			
			});
		
			// Delete Printer Clicked
			$("#btn_pdelete").on("click", function () {	
				if (confirm("Are you sure to delete this printer?")) {
					sessionStorage.editType = "DELETE";
					//$("#printEdit_form").submit();
					savePrinterData();
				} 
				return false;
			});
			
			// Function Save Printer Data 
			savePrinterData = function() {
						
				var prn_model = $("#pr_model").val();
				var prn_brand = $("#pr_brandName").val();
				var prn_desc = $("#pr_desc").val();
				var prn_price = $("#pr_price").val();
				var prn_address = $("#pr_addr").val();
				var prn_long = $("#pr_long").val();
				var prn_lat = $("#pr_lat").val();
				//alert("save printer : " + $("#p_photoCanva
				if ( sessionStorage.editType == "ADD") {	// Add a printer 
				// Get a key for a new Post.
					var newPrinterIDKey = firebaseDB.ref().child('printer_info').push().key;
					var postData= {"brand": prn_brand, "model" : prn_model, "userID" : g_uid, "description" : prn_desc, 
								"printer_status" : "Available", "price" : prn_price, 
								"location_address" : prn_address, "location_longitude" : prn_long, "location_latitude" : prn_lat } ;
					var updates = {};
					updates['/printer_info/' + newPrinterIDKey] = postData;

					//firebase.database().ref().update(updates).then(function() {
					firebaseDB.ref().update(updates).then(function() {
						$.mobile.pageContainer.pagecontainer("change", "#myPrinter");
					}, function (error) {  
						var errorcode = error.code; 
						var errorMessage = error.message;
						alert("Error : " + errorMessage);
					});
				} else if ( sessionStorage.editType == "EDIT") {
					var ref = firebaseDB.ref("printer_info/" + $("#pr_printerID").val() );
					var postData= {"brand": prn_brand, "model" : prn_model, "userID" : g_uid, "description" : prn_desc, 
								"printer_status" : "Available", "price" : prn_price, 
								"location_address" : prn_address, "location_longitude" : prn_long, "location_latitude" : prn_lat } ;
					ref.update(postData).then(function() {
						//getPrinterList();
						$.mobile.pageContainer.pagecontainer("change", "#myPrinter");
					}, function (error) {  
						var errorcode = error.code; 
						var errorMessage = error.message;
						alert("Error : " + errorMessage);
					});
				} else if ( sessionStorage.editType == "DELETE") {
					var ref = firebaseDB.ref("printer_info/" + $("#pr_printerID").val() );					
					ref.remove();
					//getPrinterList();
					$.mobile.pageContainer.pagecontainer("change", "#myPrinter");
				}
				sessionStorage.editType = ""; // Reset Edit type session variable
			};
			
			// Function for Saving Printer Info
			$("#printEdit_form").on("submit",  function() { 
				event.preventDefault(); 		// Disable default form submit action 
				savePrinterData();
			});
			
			// Retrieve printer_info 
			function getPrinterList() {		
				var ref = firebaseDB.ref("printer_info");
				var cnt = 0;
//alert("list printer");
				$.mobile.loading('show'); // Show loading 	
				var k = $("#printul li").size();
				for ( i =1; i <= k;  i++ ) 	$("#printul li").eq(1).remove(); 	// Delete List Items Before load data
				//for ( i =1; i <= k;  i++ ) 	$("#printul li").last().remove(); 	// Delete List Items Before load data
				g_printList=[];  // Clear Printer List Array
				ref.orderByChild("userID").equalTo(g_uid).limitToFirst(20).on("child_added", function(snapshot) { 		
					// Fill Printer List
					cnt ++ ;
					var data = snapshot.val();
					var ls = "<li><a href='#'><h2>" + cnt + ") " + data.brand + "_" + data.model + "</h2>" +
							 "<p>" + data.description + "</p></a>" +
							 "<a href='javascript:editPrn(" + cnt + ");' data-rel='popup' data-position-to='window' data-transition='pop' data-icon='edit'>Edit Printer</a></li>";
					
					$("#printul").append(ls).listview("refresh");
					data.printerID = snapshot.key; // Add key value to  printer list data 
					g_printList.push(data);
				
					//$("Printer "+ cnt ).insertAfter("#PrintListHeader");
					$.mobile.loading('hide'); // Show loading 	
				});
				$.mobile.loading('hide'); // Show loading 	
			}
					
			//$("#myPrinter").one("pageshow", function() {
			$(document).on("pageshow", "#myPrinter" , function(event) {
//				history.replaceState({}, "Kwik Prin","main.html");
//alert("his" + window.history);				
				getPrinterList();
			});
			
			$(document).on("pageshow", "#editPrinter" , function(event) {
				history.replaceState({}, "Kwik Print","main.html");		// return to main screen when back button is pressed
			});
			
		
		});
		
		</script>
	
</html>
