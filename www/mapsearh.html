<!DOCTYPE html>
<!-- Last Modify : 2017.04.01 -->
<html>
	<head>
		<meta charset="utf-8">
		
		<title>Kwik Print Search Map</title>
		
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <link rel='stylesheet' href='./css/jquery.mobile-1.4.5.css'  type="text/css" />
		<script src="./js/jquery.min.js" type="text/javascript"></script>
		<script src="./js/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script type="text/javascript" src="cordova.js"></script>
		<script type="text/javascript" src="js/kwikinit.js"></script>
		<!--  Google Map Javascript API -->
		<!-- script src="https://maps.googleapis.com/maps/api/js?v=3.exp&language=en"></script -->
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAldk41ArYQ0WfSnox09Qn9_f4dwMb8OI0"></script>
	
	<script>
/*
	function logout() {
		firebase.auth().signOut().then(function() {
			window.location = "index.html";
		}, function(error) {
			// An error happened 
			alert("Logout Failed");
		});
	}
*/
	</script>

<style>
.labels {
	color : blue;
}
</style>	
	
	<script>
	//var g_map ;  // Google Map object
	var g_allprinters = [] ; // Store all printers info into array
	var pmarker = [] ; 		// Printer Marker array 
	var pinfowindow = []; 	// Printer infowindow ;
	var mapOptions = {
			panControl: true, 
			zoomControl: true, 
			mapTypeControl: false, 
			scaleControl: true, 
			streetViewControl: false,  
			overviewMapControl: false, 
			center: new google.maps.LatLng(52.621124, -1.124762), // 
			zoom: 18, 
			disableDefaultUI: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
	};

	//$( document ).on( "pageinit", "#map-page", initMap() ) ;
	$(document).ready( function() {
			
		if (typeof(window.cordova)!="undefined") {	 // Check Phonegap or browser
			document.addEventListener("deviceready", onDeviceReady, false);    // For Phone Gap
		} else {	// For testing in chrome
			onDeviceReady();
		}
		

		function onDeviceReady() {
			initMap();
			getPrinters();	
			setTimeout( function(){$.mobile.loading("hide")}, 2000 );
		}
	
    	function contentHeight() {
    		var screen = $.mobile.getScreenHeight(),
    			header = $(".ui-header").hasClass("ui-header-fixed") ? $(".ui-header").outerHeight() - 1 : $(".ui-header").outerHeight(),
    			footer = $(".ui-footer").hasClass("ui-footer-fixed") ? $(".ui-footer").outerHeight() - 1 : $(".ui-footer").outerHeight(),
            ////* content div has padding of 1em = 16px (32px top+bottom). This step
    		//	can be skipped by subtracting 32px from content var directly. */
            contentCurrent = $(".ui-content").outerHeight() - $(".ui-content").height(),
            content = screen - header - footer - contentCurrent;
        ////* apply result */
    		$(".ui-content").height(content);
    	}
    /*
    	var content = $.mobile.getScreenHeight() - $(".ui-header").outerHeight() 
    					- $(".ui-footer").outerHeight() - $(".ui-content").outerHeight() 
    					+ $(".ui-content").height();
    	$(".ui-content").height(content);
    */
    	// Resize Content div when resize 
    	$(document).on("ready pagecontainertransition", contentHeight);	
    	$(window).on("throttledresize orientationchange", contentHeight);
    		
    ///
    
    	function initMap() {
    		// Variable store the last location 
    		var lastLat=52.621124, lastLong=-1.124762;  // default location
    		
			contentHeight(); // Set Map Canvas size 
    		g_map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
    		//$("#map-canvas").data("map", g_map);
			
    		// Get last Location from local storage
    		if (typeof(Storage) !== "undefined") {
    			// Code for localStorage/sessionStorage.
    			if (localStorage.getItem("lastLat")) {
    				lastLat = localStorage.getItem("lastLat") ;
    				lastLong = localStorage.getItem("lastLong") ;		
    			} 
    		} 
    		
    		drawMap(new google.maps.LatLng(lastLat, lastLong)); 
    		gotoCurrentLocation(); 
    /*		
    		function success(pos) {
//console.log("draw map");		
//console.log("pos " +  pos.coords.latitude + ", " +  pos.coords.longitude );	
			drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude)); // get current location 
			// Store the last location 
			localStorage.setItem("lastLat", pos.coords.latitude );
			localStorage.setItem("lastLong", pos.coords.longitude );		
		}
		
		function error(err) {
			alert("Location Error : " + err.message + "\nPlease make sure GPS is turned ON" );
			console.warn(`ERROR(${err.code}): ${err.message}`);
		};
	
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition( success, error, {maximumAge: 500000, enableHighAccuracy:true, timeout: 30000} );
		}
*/		
		}
	
		function drawMap(latlng) {   
    		mapOptions.center = latlng;		
    		g_map.panTo(mapOptions.center);		// Move to current Location 
            // Add an overlay to the map of current lat/lng
            my_marker = new google.maps.Marker({
                position: latlng,
                map: g_map,
                title : "My Location",
    			draggable : true,
				label : { text: "I" },
				labelContent: "A",
				labelAnchor: new google.maps.Point(3, 30),
				labelClass: "labels", // the CSS class for the label
				labelInBackground: true,
				zIndex:99999999
				//icon: pinSymbol('blue')
    			//icon : "img/printer-icon2.png"
            });
			
			 var infowindow = new google.maps.InfoWindow({
				content: "<b><font color='blue'>Myself</b>",
				maxWidth : 200
			});
  
			my_marker.addListener('click', function() {
				infowindow.open(g_map, my_marker);
			});	
			
        }
			
		function getPrinters() {
			var ref1 = firebaseDB.ref("printer_info");
			
			var cnt = 0; 		
			//ref.orderByChild("location_longitude").limitToFirst(100).on("child_added", function(snapshot) { 		
			//ref.orderByKey().limitToFirst(100).on("child_added", function(snapshot) { 
			
			$.mobile.loading('show'); // Show loading 	
			ref1.orderByKey().limitToFirst(100).on("child_added", function(snapshot) { 		
				var pdata = snapshot.val();
				pdata.printerID = snapshot.key; // Add key value to  printer list data 
				var uid = pdata.userID ;
//console.log("uid " + uid); 
				var ref2 = firebaseDB.ref("users/" + uid).once("value", function(snapshot2) {
					var udata = snapshot2.val();
					pdata.user_name = udata.user_name;
					pdata.email_address = udata.email_address;
					pdata.phone_no = udata.phone_no;
					//pdata.data("user_name" : udata.user_name);
			
				});
				//ref2.child("").child(userId).once('value', function(mediaSnap) {
				//	console.log(userId + ":" + mediaSnap.val().name);
			
				//var lng = pdata.location_longitude;
				//var lat = pdata.location_latitude;
				
				g_allprinters.push(pdata);			
				cnt ++ ;
			});
			
		}

		function gotoCurrentLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition( 
				function(pos) { 
					lat = pos.coords.latitude ;
					lng = pos.coords.longitude ;
//console.log	("lat : " + lat + ", lng : " + lng);		
					mapOptions.center = new google.maps.LatLng( pos.coords.latitude, pos.coords.longitude) ;
					g_map.panTo(mapOptions.center);			
					my_marker.setPosition(mapOptions.center);
				}, function(err) {
					alert("Location Error : " + err.message + "\nPlease make sure GPS is turned ON" );
					console.warn(`ERROR(${err.code}): ${err.message}`);
				}, {maximumAge: 500000, enableHighAccuracy:false, timeout: 30000});
			}
		}
	
		
		function showPrinters( myLatLng, search_radius, search_type) {
			//var cnt = g_allprinters.length; 
			//g_allprinters.forEach(function(itm) {
			pmarker = [];
			pinfowindow = [];
			for (i=0; i < g_allprinters.length; i++) {
				var lat = g_allprinters[i].location_latitude;
				var lng = g_allprinters[i].location_longitude;
				var location = new google.maps.LatLng ( lat, lng );
//console.log(g_allprinters[i]);	
				var ico = (g_allprinters[i].printer_status=="Available")?  "img/printer-icon2.png" : "img/printer-icon_bk.png" ;
				pmarker[i] = new google.maps.Marker({
					position: location,
					map: g_map,
					icon : ico, 
					draggable : false,
					label : "" + i,
					title : g_allprinters[i].user_name,
					idx : i, 
					userID : g_allprinters[i].userID,
					printerID : g_allprinters[i].printerID,
					address : g_allprinters[i].location_address
					
				});
//console.log(g_allprinters[i]);					
				var infotext = "<b>User:"+ g_allprinters[i].user_name + " (" +  g_allprinters[i].email_address + ")</b><br>" +
							   "<i>Printer:" + g_allprinters[i].brand + "_" + g_allprinters[i].model + "</i><br>" +
							   "Address:" + g_allprinters[i].location_address + "<br>" + 
							   "<button>Chat with user</button>";
							   
				
				pinfowindow[i] =  new google.maps.InfoWindow({
					content: infotext,
					maxWidth: 400
				});
//console.log(pinfowindow[i]);
//alert("click");				
				//pmarker[i].addListener('click', function() {
				google.maps.event.addListener(pmarker[i], "click", function(idx) {
						return function() { 
							pinfowindow[idx].open(g_map, pmarker[idx]);
							setTimeout(function() { pinfowindow[idx].close(); }, 5000); 
						}
					}(i)
				);

					//pinfowindow[i].open(g_map, pmarker);
				//});

//console.log(pmarker[i]);		
				//pmarker.push(marker);
			}
			
			$.mobile.loading('hide'); // Hide loading 	
		}
	
		/// Menu 
		$("#mnu_curlocation").on("click", function() {
			$("#map_menu").panel("close");
			gotoCurrentLocation();	
		});
	
		$("#mnu_showprinter").on("click", function() {
			$("#map_menu").panel("close");
			showPrinters();	
		});
	
		google.maps.event.addListener(my_marker, "drag", function(){
			console.log( my_marker.position.toUrlValue()) ;
		});

	
	
	
	}); // end doc ready
 

	</script>
	
	
	</head>
	<body>
		<div data-role="page" class="ui-responsive-panel">
			<div data-role="header" data-theme="a">
				<h1>Kwik Print</h1>
				<a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
				<a href="#map_menu" data-icon="grid" data-iconpos="notext"></a>
				<!-- a href="#add-form" data-icon="plus" data-iconpos="notext">Add</a -->
			</div><!-- /header -->			
			
			<div role="main" class="ui-content" data-theme="a" id="map-canvas">
				Map Canvas
			</div>
			
			<div data-role="footer" class="jqm-footer" data-position="fixed">
				<p class="jqm-version"></p>
				<p>Search Printer</p>
			</div><!-- /jqm-footer -->

				<div data-role="panel" data-position="left" data-position-fixed="false" data-display="overlay" id="nav-panel" data-theme="a">
					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="close">...</a>
						</li>
						<li data-filtertext="" data-icon="home">
							<a href="#" data-icon="home" onclick="window.location='main.html'">Home Page</a>
						</li>
						<!-- <li data-filtertext=""> -->
							<!-- <a href="#" id="setrange">Set Search Range</a> -->
						<!-- </li> -->
					</ul>
					<!-- panel content goes here -->
				</div><!-- /panel -->
				
				<div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="map_menu" data-theme="a">
					<ul data-role="listview" data-theme="b" data-divider-theme="a" >
						<li><a href="#" data-rel="close" data-icon="delete">Close</a></li>
						<li data-icon="location"><a href="#" id="mnu_curlocation" >My location</a>
						<li data-icon="navigation"><a href="#" id="mnu_showprinter" data-icon="location">Show nearby printers</a>
						</li>
					</ul>
				</div>
		
		</div><!-- /page -->
	
	</body>
</html>
