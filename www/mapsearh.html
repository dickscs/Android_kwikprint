<!DOCTYPE html>
<!-- Last Modify : 2017.04.15 -->
<html>
	<head>
		<meta charset="utf-8">
		
		<title>Kwik Print Search Map</title>
		
		<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
        <link rel='stylesheet' href='./css/jquery.mobile-1.4.5.css'  type="text/css" />
		<script src="./js/jquery.min.js" type="text/javascript"></script>
		<script src="./js/jquery.mobile-1.4.5.min.js" type="text/javascript"></script>
		<script src="https://www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
		<script type="text/javascript" src="cordova.js"></script>
		<script type="text/javascript" src="js/kwikinit.js"></script>
		<!--  Google Map Javascript API -->
		<!-- script src="https://maps.googleapis.com/maps/api/js?v=3.exp&language=en"></script -->
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAldk41ArYQ0WfSnox09Qn9_f4dwMb8OI0"></script>
	
	<script>
/*
	function logout() {
		firebase.auth().signOut().then(function() {
			window.location = "index.html";
		}, function(error) {
			// An error happened 
			alert("Logout Failed");
		});
	}
*/
	</script>

<style>
.labels {
	color : blue;
}
</style>	
	
	<script>
	//var g_map ;  // Google Map object
	var g_uid ;  	// current user 
	var g_allprinters = [] ; 	// Store all printers info into array
	var pmarker = [] ; 			// Printer Marker array 
	var pinfowindow = []; 		// Printer infowindow ;
	var g_curLat = 52.620917, g_curLng =  -1.124071 ; 	// Current position's Latitude, Longitude
	var mapOptions = {
			panControl: true, 
			zoomControl: true, 
			mapTypeControl: false, 
			scaleControl: true, 
			streetViewControl: false,  
			overviewMapControl: false, 
			center: new google.maps.LatLng(g_curLat, g_curLng), // 
			zoom: 18, 
			disableDefaultUI: true,
			mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	
	
	//$( document ).on( "pageinit", "#map-page", initMap() ) ;
	$(document).ready( function() {
			
		if (typeof(window.cordova)!="undefined") {	 // Check Phonegap or browser
			document.addEventListener("deviceready", onDeviceReady, false);    // For Phone Gap
		} else {	// For testing in chrome
			onDeviceReady();
		}
		

		function onDeviceReady() {
		
			g_uid = window.sessionStorage.getItem("currentUID");   // get currentUID
			initMap();
			getPrinters();	
			setTimeout( function(){$.mobile.loading("hide")}, 2000 );
		}
	
    	function contentHeight() {
    		var screen = $.mobile.getScreenHeight(),
    			header = $(".ui-header").hasClass("ui-header-fixed") ? $(".ui-header").outerHeight() - 1 : $(".ui-header").outerHeight(),
    			footer = $(".ui-footer").hasClass("ui-footer-fixed") ? $(".ui-footer").outerHeight() - 1 : $(".ui-footer").outerHeight(),
            ////* content div has padding of 1em = 16px (32px top+bottom). This step
    		//	can be skipped by subtracting 32px from content var directly. */
            contentCurrent = $(".ui-content").outerHeight() - $(".ui-content").height(),
            content = screen - header - footer - contentCurrent;
        ////* apply result */
    		$(".ui-content").height(content);
    	}
    /*
    	var content = $.mobile.getScreenHeight() - $(".ui-header").outerHeight() 
    					- $(".ui-footer").outerHeight() - $(".ui-content").outerHeight() 
    					+ $(".ui-content").height();
    	$(".ui-content").height(content);
    */
    	// Resize Content div when resize 
    	$(document).on("ready pagecontainertransition", contentHeight);	
    	$(window).on("throttledresize orientationchange", contentHeight);
    		
    ///
    
    	function initMap() {
    		// Variable store the last location 
    		var lastLat=52.621124, lastLong=-1.124762;  // default location
    		var zoom = 18 ;
			contentHeight(); // Set Map Canvas size 
alert( "typeof(Storage : " + typeof(Storage));		
				// Get last Location from local storage
    		if (typeof(Storage) !== "undefined") {
    			// Code for localStorage/sessionStorage.
    			if (localStorage.getItem("lastLat")) {			// Get Last Map Position
    				lastLat = localStorage.getItem("lastLat") ;
    				lastLong = localStorage.getItem("lastLong") ;		
    			} 
				
				if (localStorage.getItem("mapZoom")) {		// Get Last Map zoom level
					zoom = parseInt(localStorage.getItem("mapZoom"));
				}
    		} 
//alert(typeof(zoom));
//console.log(  " lastLat : " + lastLat + ", lastLong : " + lastLong + ", zoom : " + zoom);	
			mapOptions.zoom = zoom ;
			mapOptions.center =  new google.maps.LatLng(lastLat, lastLong)
    		g_map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
    		//$("#map-canvas").data("map", g_map);
			
    	
    		drawMap(new google.maps.LatLng(lastLat, lastLong)); 
			// Pan to last position 
			mapOptions.center =  new google.maps.LatLng(lastLat,lastLong) ;
    		g_map.panTo(mapOptions.center);	
			
    		//gotoCurrentLocation(); 
    /*		
    		function success(pos) {
//console.log("draw map");		
//console.log("pos " +  pos.coords.latitude + ", " +  pos.coords.longitude );	
			drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude)); // get current location 
			// Store the last location 
			localStorage.setItem("lastLat", pos.coords.latitude );
			localStorage.setItem("lastLong", pos.coords.longitude );		
		}
		
		function error(err) {
			alert("Location Error : " + err.message + "\nPlease make sure GPS is turned ON" );
			console.warn(`ERROR(${err.code}): ${err.message}`);
		};
	
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition( success, error, {maximumAge: 500000, enableHighAccuracy:true, timeout: 30000} );
		}
*/		
		}
	
		//function drawMap(latlng) {   
		function drawMap(latlng, zoom) {   
    		mapOptions.center = latlng;		
    		g_map.panTo(mapOptions.center);		// Move to current Location 
            // Add an overlay to the map of current lat/lng
            my_marker = new google.maps.Marker({
                position: latlng,
                map: g_map,
                title : "My Location",
    			draggable : true,
				label : { text: "I" },
				labelContent: "A",
				labelAnchor: new google.maps.Point(3, 30),
				labelClass: "labels", // the CSS class for the label
				labelInBackground: true,
				zIndex:99999999
				//icon: pinSymbol('blue')
    			//icon : "img/printer-icon2.png"
            });
			
			 var infowindow = new google.maps.InfoWindow({
				content: "<b><font color='blue'>Myself</b>",
				maxWidth : 200
			});
  
			my_marker.addListener('click', function() {
				infowindow.open(g_map, my_marker);
			});	
			// Alter current location Latitude/Longitude when "My Marker" is moved 
			my_marker.addListener('dragend', function(event) {
				g_curLat = event.latLng.lat();
				g_curLng = event.latLng.lng();			
//console.log(" glat " + g_curLat + ", glng : " + g_curLng);		
			});
			
        }
			
		function getPrinters() {
			var ref1 = firebaseDB.ref("printer_info");
			
			var cnt = 0; 		
			//ref.orderByChild("location_longitude").limitToFirst(100).on("child_added", function(snapshot) { 		
			//ref.orderByKey().limitToFirst(100).on("child_added", function(snapshot) { 
			
			$.mobile.loading('show'); // Show loading 	
			ref1.orderByKey().limitToFirst(100).on("child_added", function(snapshot) { 		
				var pdata = snapshot.val();
				pdata.printerID = snapshot.key; // Add key value to  printer list data 
				var uid = pdata.userID ;
//console.log("uid " + uid); 
				var ref2 = firebaseDB.ref("users/" + uid).once("value", function(snapshot2) {
					var udata = snapshot2.val();
					pdata.user_name = udata.user_name;
					pdata.email_address = udata.email_address;
					pdata.phone_no = udata.phone_no;
					//pdata.data("user_name" : udata.user_name);
					// Calculate printer's distance from current location
					var dist = LatLng2distance( )
			
				});
				//ref2.child("").child(userId).once('value', function(mediaSnap) {
				//	console.log(userId + ":" + mediaSnap.val().name);
			
				//var lng = pdata.location_longitude;
				//var lat = pdata.location_latitude;
				
				g_allprinters.push(pdata);			
				cnt ++ ;
			});
			
		}

		function gotoCurrentLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition( 
				function(pos) { 
					lat = pos.coords.latitude ;
					lng = pos.coords.longitude ;
					g_curLat = pos.coords.latitude; 		// set gobal lat/lng Location
					g_curLng =  pos.coords.longitude ;
//console.log	("lat : " + lat + ", lng : " + lng);		
					mapOptions.center = new google.maps.LatLng( pos.coords.latitude, pos.coords.longitude) ;
					g_map.panTo(mapOptions.center);			
					my_marker.setPosition(mapOptions.center);
				}, function(err) {
					alert("Location Error : " + err.message + "\nPlease make sure GPS is turned ON" );
					console.warn(`ERROR(${err.code}): ${err.message}`);
				}, {maximumAge: 500000, enableHighAccuracy:false, timeout: 30000});
			}
		}
	
		
		//function showPrinters( myLatLng, search_radius, search_type) {
		function showPrinters( search_radius, show_avail) {
			//var cnt = g_allprinters.length; 
			//g_allprinters.forEach(function(itm) {
			// clear all markers
			for (var i=0; i < pmarker.length ; i++) {
				if (pmarker[i]) pmarker[i].setMap(null);
			}
			//
			pmarker = [];
			pinfowindow = [];
		
			var near_dist=9999999999.9, near_lat=0, near_lng=0;	// Store the nearest Printer Position
			
			for (i=0; i < g_allprinters.length; i++) {
				var lat = g_allprinters[i].location_latitude;
				var lng = g_allprinters[i].location_longitude;
				var location = new google.maps.LatLng ( lat, lng );
				var distance = LatLng2distance(g_curLat, lat, g_curLng, lng) ;	// Calculate the distance from my marker position
				var isAvailable = g_allprinters[i].printer_status=="Available" ;
//console.log( i + "->distance:"  + distance + " radius: " + search_radius   + " distance <= search_radius:" + (distance <= search_radius) ) ;
//console.log(g_allprinters[i]);	
				if (search_radius == 0) search_radius = 9999999999.9 ;
				if ( (!show_avail || isAvailable) && (distance <= search_radius) ) {   // Show printer within search Range and Availability 
					
					if ( distance < near_dist) {	// Get the nearest printer position
						near_dist = distance ;
						near_lat = lat; 
						near_lng = lng;
					}
					var ico = (isAvailable)?  "img/printer-icon2.png" : "img/printer-icon_bk.png" ;
					pmarker[i] = new google.maps.Marker({
						position: location,
						map: g_map,
						icon : ico, 
						draggable : false,
						label : "" + i,
						title : g_allprinters[i].user_name,
						idx : i, 
						userID : g_allprinters[i].userID,
						printerID : g_allprinters[i].printerID,
						address : g_allprinters[i].location_address
						
					});
	//console.log(g_allprinters[i]);					
					var infotext = "<b>User:"+ g_allprinters[i].user_name + " (" +  g_allprinters[i].email_address + ")</b><br>" +
								"<i>Printer:" + g_allprinters[i].brand + "_" + g_allprinters[i].model + "</i><br>" +
								"Address:" + g_allprinters[i].location_address + "<br>" ;
								
					if ( g_allprinters[i].userID != g_uid) {  // Display Chat if user not equal to current user
						infotext += "<button onclick='goChat(\"" + g_allprinters[i].userID + "\");'>Chat with user</button>";
					}
	//console.log(infotext);							   
					
					pinfowindow[i] =  new google.maps.InfoWindow({
						content: infotext,
						maxWidth: 400
					});
	//console.log(pinfowindow[i]);
	//alert("click");				
					//pmarker[i].addListener('click', function() {
					google.maps.event.addListener(pmarker[i], "click", function(idx) {
							return function() { 
								pinfowindow[idx].open(g_map, pmarker[idx]);
								setTimeout(function() { pinfowindow[idx].close(); }, 5000); 
							}
						}(i)
					);
					
				}	// end compare range

			}
			// Move to the nearest printer
			mapOptions.center =  new google.maps.LatLng(near_lat,near_lng) ;
    		g_map.panTo(mapOptions.center);	
			$.mobile.loading('hide'); // Hide loading 	
		}
	
		/// Menu 
		$("#mnu_curlocation").on("click", function() {
			$("#map_menu").panel("close");
			gotoCurrentLocation();	
		});
		
		 g_map.addListener('center_changed', function() {
			var latlng = this.getCenter(); 
			var zoom = this.getZoom();
//console.log( "latlng : " + latlng + " . " + latlng.lat() + ", zoom : " + zoom) ;
			localStorage.setItem("lastLat", latlng.lat() );
			localStorage.setItem("lastLong", latlng.lng() );	
			localStorage.setItem("mapZoom", zoom );	
		 });
		 
		 g_map.addListener('zoom_changed', function() {
			var latlng = this.getCenter(); 
			var zoom = this.getZoom();
//console.log( "latlng : " + latlng + " . " + latlng.lat() + ", zoom : " + zoom) ;
			localStorage.setItem("lastLat", latlng.lat() );
			localStorage.setItem("lastLong", latlng.lng() );	
			localStorage.setItem("mapZoom", zoom );	
		 });
		 

	
//		$("#mnu_showprinter").on("click", function() {
//			$("#map_menu").panel("close");
//			showPrinters();	
//		});

/*		
		google.maps.event.addListener(my_marker, "drag", function(){
			//console.log( my_marker.position.toUrlValue()) ;
		});
*/		
		
		$("#pSearch").on("click", function() {
			var range = $("#slider-range").val();
			var type =  $("#showAll").is(":checked");
//console.log("r: " + range + " t " + type)	;
			$("#popSearchRange").popup("close");
			$("#map_menu").panel("close");
			showPrinters(range, type) ;
		}); 
	
	}); // end doc ready
 
 		// Do Chat 	
		function goChat( relateID) {
			window.location.href  = "chats.html?userID=" + g_uid + "&relateID=" + relateID;
		}
	

	</script>
	
	
	</head>
	<body>
		<div data-role="page" class="ui-responsive-panel">
			<div data-role="header" data-theme="a">
				<h1>Kwik Print</h1>
				<a href="#nav-panel" data-icon="bars" data-iconpos="notext">Menu</a>
				<a href="#map_menu" data-icon="grid" data-iconpos="notext"></a>
				<!-- a href="#add-form" data-icon="plus" data-iconpos="notext">Add</a -->
			</div><!-- /header -->			
			
			<div role="main" class="ui-content" data-theme="a" id="map-canvas">
				Map Canvas
			</div>
			
			<div data-role="footer" class="jqm-footer" data-position="fixed">
				<p class="jqm-version"></p>
				<p>Search Printer</p>
			</div><!-- /jqm-footer -->

				<div data-role="panel" data-position="left" data-position-fixed="false" data-display="overlay" id="nav-panel" data-theme="a">
					<ul data-role="listview" data-theme="a" data-divider-theme="a" style="margin-top:-16px;" class="nav-search">
						<li data-icon="delete" style="background-color:#111;">
							<a href="#" data-rel="close">...</a>
						</li>
						<li data-filtertext="" data-icon="home">
							<a href="#" data-icon="home" onclick="window.location='main.html'">Home Page</a>
						</li>
						<!-- <li data-filtertext=""> -->
							<!-- <a href="#" id="setrange">Set Search Range</a> -->
						<!-- </li> -->
					</ul>
					<!-- panel content goes here -->
				</div><!-- /panel -->
				
				<div data-role="panel" data-position="right" data-position-fixed="false" data-display="overlay" id="map_menu" data-theme="a">
					<ul data-role="listview" data-theme="b" data-divider-theme="a" >
						<li><a href="#" data-rel="close" data-icon="delete">Close</a></li>
						<li data-icon="location"><a href="#" id="mnu_curlocation" >My location</a>
						<li data-icon="navigation"><a href="#popSearchRange" data-rel="popup" data-icon="location">Find nearest printers</a>
						<!-- <li data-icon="navigation"><a href="#" id="mnu_showprinter" data-icon="location">Show nearby printers</a> -->
						</li>
					</ul>
				</div>
				<!-- Search Range popup  -->
				<div data-role="popup" id="popSearchRange" data-theme="b">
					<div class="ui-field-contain">
					<label for="slider-range">Search radius(km):<i style="font-size:8pt;">( 0 = unlimited )</i></label>
					<input type="range" name="slider-range" id="slider-range" value="25" min="0" max="100">
					<label><input name="showAll" id="showAll" type="checkbox">Show available printers only</label>
					<button id="pSearch"> Search </button>
					</div>
				</div>
		
		</div><!-- /page -->
	
	</body>
</html>
